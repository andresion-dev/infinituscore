trigger:
  branches:
    include:
      - main

variables:
  applicationGatewayIp: '128.203.104.178'  # <-- Substitua aqui pelo IP real do App Gateway

pool:
  vmImage: 'windows-latest'

stages:
- stage: ExecutarScripts
  displayName: 'Executar Scripts PowerShell do Projeto'
  jobs:
  - job: ExecutarTodosScripts
    displayName: 'Executar .ps1 da pasta Script/'
    steps:

    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "======================"
          Write-Host "Estrutura da árvore do repositório:"
          Get-ChildItem -Path "$(Build.SourcesDirectory)" -Recurse | Select-Object FullName
          Write-Host "======================"
      displayName: 'Listar estrutura completa do repositório'

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'AzureServiceConnection'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $scriptPath = "$(Build.SourcesDirectory)/Script"
          $ip = "$(applicationGatewayIp)"
          $targetScript = Join-Path $scriptPath "16-deploy-Criar um registro DNS.ps1"

          Write-Host "Executando script de DNS com IP: $ip"
          & $targetScript $ip
  

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'AzureServiceConnection'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $scriptPath = "$(Build.SourcesDirectory)/Script"
          $scripts = Get-ChildItem $scriptPath -Filter *.ps1 | Where-Object { $_.Name -notlike "16-deploy-Criar um registro DNS.ps1" } | Sort-Object Name

          foreach ($script in $scripts) {
              Write-Host "Executando $($script.Name)..."
              & $script.FullName
          }
      displayName: 'Executar os demais scripts autenticados'


